---
layout: single
title: "[Spring] AOP"
permalink: /21
tag: spring
categories: back-end
toc: true
toc_sticky: true
author_profile: false
sidebar:
  nav: "docs"
---

AOP는 기존에 사용하던 OPP를 대체하기 위한 것이 아닌 횡단 관심사를 깔끔하게 처리하기 위해 OOP의 부족한 부분을 보조하는 목적으로 개발됨.
<br>
<br>
**객체 지향 프로그래밍 = OOP**

**관점 지향 프로그래밍 = AOP**
<br>
<br>
AOP는 기존과 다른 프로그램 구조 사고 방식을 제공함으로써 객체 지향 프로그래밍의 부족한 부분을 보완한다.

Aspect는 여러 유형과 객체 간에 발생하는 문제 (ex - 트랜잭션)의 모듈화를 가능하게 함.
<br>
<br>
OOP의 모듈화의 핵심 단위는 클래스,

AOP의 모듈화의 핵심 단위는 관점.
<br>
<br>

**AOP가 필요한 이유**

특정 로직을 애플리케이션 전반에 적용하는 문제는 일반적인 OOP 방식으로는 

해결이 어렵기 때문에 핵심 기능과 부가 기능을 분리하는 AOP 방식이 필요함.
<br>
<br>

- **중요 개념**
    - 핵심 기능 : 업무 로직을 포함하는 기능
    - 부가 기능 : 핵심 기능을 도와주는 부가적인 기능
        - 로깅, 보안, 트랜잭션 등
    - Aspect : 부가 기능을 정의한 코드인 어드바이스와 어드바이스를 어디에 적용할지 결정하는 포인트컷을 합친 개념. (Advice + PointCut = Aspect)

- **핵심**
    - OOP 방식의 프로그래밍을 했을 때 여러 곳에서 공통적으로 사용되는 부가 기능의 중복 코드가 발생하게 됨.
    - 중복되는 부가 기능에 수정 및 삭제가 필요하게 되면 사용되는 모든 곳에 수정 및 삭제 동작을 해줘야 함.
    - 관점(관심) 지향 프로그래밍(AOP)는 OOP 방식의 불필요한 반복을 해결하기 위한 방법
---
<br>

## AOP 용어 및 개념

- **AOP 용어**
    - Aspect 애스팩트
    - Join Point 조인 포인트
    - Advice 어드바이스
    - Pointcut 포인트컷
    - Weaving 위빙
    - Proxy 프록시
    - Target 타겟
    - Advisor 어드바이저
<br>
<br>

### Aspect

---

- 여러 객체에 공통으로 적용되는 기능을 말함 (공통 기능)
- 어드바이스 + 포인트컷을 모듈화하여 애플리케이션에 포함되는 횡단 기능
- 여러 어드바이솨 포인트컷이 함께 존재함

<br>

### Join Point

Aspect에서 어디에 적용할 것인지 결정 ex) 메서드, 필드, 객체 생성시점 등

Spring AOP는 메서드 레벨만 적용 가능

---

- 클래스 초기화, 객체 인스턴스화, 메소드 호출, 필드 접근, 예외 발생과 같은 애플리케이션 실행 흐름에서의 특정 포인트를 의미함
- 애플리케이션에 새로운 동작을 추가하기 위해 조인포인트에 aspect code를 추가할 수 있음
- 횡단 관심은 조인포인트 전/후에 AOP에 의해 자동으로 추가됨
- 스프링 AOP는 프록시 방식을 사용하므로 조인 포인트는 항상 메소드 실행 지점으로 제한됨
- 어드바이스 적용이 필요한 곳은 애플리케이션 내에 메서드를 가짐.

<br>

### Advice

부가 기능, 언제 적용할 것인가?

ex) Before AfterReturning(예외가 발생한 이후), AfterThrowing(예외 처리 이후), After, Around(메소드 실행 전 후)

---

- 조인포인트에서 수행되는 코드
- Aspect를 언제 핵심 코드에 적용할 지를 정의
- 시스템 전체 애스펙트에 API 호출을 제공
- 메소드를 호출하기 전에 각 상세 정보와 모든 메소드를 로그로 남시시 우해 메소드 시작 전의 포인트인 조인포인트 S 를 선택

<br>

### Pointcut

Aspect에서 적용될 위치를 지정

---

- 조인 포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능
- AspectJ 표현식을 사용해서 지정
- 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트컷으로 선별 가능

<br>

### Weaving

---

- 포인트컷으로 결정한 타겟의 조인 포인트에 어드바이스를 적용
    - Advice를 핵심 코드에 적용하는 것을 의미
- 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가 할 수 있음
- AOP 적용을 위해 애스펙트 객체에 연결한 상태
    - 컴파일 타임
    - 로드 타임
    - 런타임, 스프링 AOP는 런타임, 프록시 방식

<br>

### AOP proxy

---

- AOP 기능을 구현하기 위해 만든 프록시 객체
- 스프링에서 AOP 프록시는 JDK 동적 프록시 또는 CGLIB 프록시이다

<br>

### Target

---

- 핵심 기능을 담고 있는 모듈로 타겟은 부가기능을 부여할 대상이 됨
- Advice를 받는 객체이고 포인트컷으로 결정됨

<br>

### Advisor

---

- 하나의 어드바이스와 하나의 포인트 컷으로 구성됨
- **스프링 AOP에서만 사용되는 특별한 용어이다**

<br>

## 타입별 Advice

- Aspect를 언제 핵심 코드에 적용할지를 정의한다.
- 부가 기능에 해당된다.
- 특정 조인 포인트에서 애스팩트에 의해 취해지는 조치이다.

<br>

### Advice 순서

어드바이스는 기본적으로 순서를 보장하지 않음.

순서를 지정하고 싶으면 @Aspect 적용 단위로 org.springframework.core.annotation.@Order 애너테이션을 적용해야 함.

- **어드바이스 단위가 아니라 클래스 단위로 적용할 수 있음.**
- 하나의 애스펙트에 여러 어드바이스가 존재하면 순서를 보장 받을 수 없음.

**애스펙트를 별도의 클래스로 분리**해야 함.

---

<br>

### Advice 종류

- **Before**
    - 조인 포인트 실행 이전에 실행한다.
    - 타겟 메서드가 실행되기 전에 처리해야할 필요가 있는 부가 기능을 메서드 호출 전에 실행한다.
    - Before Advice 구현한 메서드는 일반적으로 **리턴타입이 void** 이다.
        - 리턴 값을 갖더라도 실제 Advide 적용 과정에 아무 영향이 없다.
    - 주의점으로 메서드에서 예외를 발생시킬 경우 대상 객체의 메서드가 호출되지 않게 된다는 점이 있다.
    
    ```java
    @Before("hello.aop.order.aop.Pointcuts.orderAndService()")
    public void doBefore(JoinPoint joinPoint) {
        log.info("[before] {}", joinPoint.getSignature());
    }
    ```
    
    - 작업 흐름을 변경할 수 없다.
    - 메서드 종료 시 자동으로 다음 타겟이 호출된다. (예외가 발생하면 다음 코드는 호출되지 않는다.)

<br>

- **After returning**
    - 조인 포인트가 정상 완료 후 실행한다.
    - 메서드가 예외 없이 실행된 이후에 공통 기능을 실행한다.
    
    ```java
    @AfterReturning(value = "hello.aop.order.aop.Pointcuts.orderAndService()", returning = "result")
    public void doReturn(JoinPoint joinPoint, Object result) {
        log.info("[return] {} return={}", joinPoint.getSignature(), result);
    }
    ```
    
    - 메서드 실행이 정상적으로 반환될 때 실행
    - returning 속성에 사용된 이름은 어드바이스 메서드의 매개변수 이름과 일치해야 함
    - returning 절에 지정된 타입의 값을 반환하는 메서드만 대상을 실행한다

<br>

- **After (finally)**
    - 조인 포인트의 동작(정상 또는 예외)과는 상관없이 실행한다.
        - 예외 동작의 finally를 생각하면 됨.
    - 메서드 실행 후 공통 기능을 실행한다.
    - 일반적으로 리소스를 해체하는데 사용한다.

<br>

- **Around**
    - 메서드 호출 전후에 수행하며 가장 강력한 어드바이스이다.
        - 조인 포인트 실행 여부 선택, 반환 값 변환, 예외 변환 등이 가능하다.
    - 메서드 실행 전 & 후, 예외 발생 시점에 공통 기능을 실행한다.
    - 가장 강력한 어드바이스이다.
        - 조인 포인트 실행 여부 선택 - joinPoint.proceed()
        - 전달 값 변환 - joinPoint.proceed(args[])
        - 반환 값 변환
        - 예외 변환
        - try ~ catch ~ finally 가 들어가는 구문 처리 가능하다.
    - 어드바이스의 첫 번째 파라미터는 ProceedingJoinPoint를 사용해야 한다.
    - proceed()를 통해 대상을 실행한다.
    - proceed()를 여러번 실행할 수 있다.

<br>
<br>

## Pointcut 표현식

포인트컷은 관심 조인 포인트를 결정하므로 어드바이스가 실행되는 시기를 제어할 수 있다.

AspectJ는 포인트컷을 편리하게 표현하기 위한 특별한 표현식을 제공한다.

ex) `@Pointcut("execution(* hello.aop.order..*(..))")`

```java
@Pointcut("execution(* transfer(..))") // 포인트컷 표현식
private void anyOldTransfer() {} // 포인트컷 서명
```

포인트컷 표현식은 **AspectJ pointcut expression ⇒ AspectJ**가 제공하는 포인트컷 표현식을 줄여서 표현하는 것이다.

<br>

**포인트컷 지시자**

포인트컷 표현식은 execution 같은 포인트컷 지시자(Pointcut Designator, PCD)로 시작한다.

| 종류 | 설명 |
| --- | --- |
| execution | 메서드 실행 조인트 포인트를 매칭한다.스프링 AOP에서 가장 많이 사용하며, 기능도 복잡하다. |
| within | 특정 타입 내의 조인 포인트를 매칭한다. |
| args | 인자가 주어진 타입의 인스턴스인 조인 포인트 |
| this | 스프링 빈 객체(스프링 AOP 프록시)를 대상으로 하는 조인 포인트 |
| target | Target 객체(스프링 AOP 프록시가 가르키는 실제 대상)를 대상으로 하는 조인 포인트 |
| @target | 실행 객체의 클래스에 주어진 타입의 애너테이션이 있는 조인 포인트 |
| @within | 주어진 애너테이션이 있는 타입 내 조인 포인트 |
| @annotation | 메서드가 주어니 애너테이션을 가지고 있는 조인 포인트를 매칭 |
| @args | 전달된 실제 인수의 런타임 타입이 주어진 타입의 애너테이션을 갖는 조인 포인트 |
| bean | 스프링 전용 포인트컷 지시자이고 빈의 이름으로 포인트컷을 지정한다. |

`execution`을 가장 많이 사용하고 나머지는 자주 사용하지 않습니다.

<br>

## JoinPoint

**AOP 적용 위치**

- AOP는 지금까지 학습한 메서드 실행 위치 뿐만 아니라 다음과 같은 다양한 위치에 적용할 수 있다.
- 적용 가능 지점(조인 포인트): 생성자, 필드 값 접근, static 메서드 접근, 메서드 실행
- AOP를 수행하는 메소드는 이 JoinPoint 인스턴스를 인자로 받게 된다.
- JoinPoint 인스턴스에서 조인 포인트 지점의 정보를 얻어내야 한다.

---

<br>

조인 포인트는 추상적인 개념이고, AOP를 적용할 수 있는 지점을 의미한다.

- 어드바이스가 적용될 수 있는 위치, 메소드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 같은 프로그램 실행 중 지점을 나타낸다.
- AspectJ를 사용해서 컴파일 시점과 클래스 로딩 시점에 적용하는 AOP는 바이트코드를 실제 조작하기 때문에 해당 기능을 모든 지점에 다 적용할 수 있다.
- 프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP를 적용할 수 있다.
- 프록시는 메서드 오버라이딩 개념으로 동작한다.
- 생성자나 static 메서드, 필드 값 접근에는 프록시 개녀밍 적용될 수 없다.
- 프록시를 사용하는 **스프링 AOP의 조인 포인트는 메서드 실행으로 제한**된다.
- 프록시 방식을 사용하는 스프링 AOP는 스프링 컨테이너가 관리할 수 있는 **스프링 빈에만 AOP를 적용**할 수 있다.
- JoinPoint 메소드는 어드바이스의 종류에 따라 사용방법이 다소 다르지만 기본적으로 어드바이스 메소드에 매개변수로 선언만 하면 된다.
